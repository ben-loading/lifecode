# 批量更新脚本执行指南

## 前置条件

1. ✅ 已执行 SQL 迁移（`add_normalized_birth_fields.sql`）添加字段和索引
2. ✅ 已安装 Node.js 和 npm
3. ✅ 项目已安装依赖（`npm install`）

## 执行步骤

### 方式一：使用 dotenv（推荐，自动加载 .env.local）

```bash
# 1. 安装 dotenv-cli（如果还没有）
npm install -g dotenv-cli

# 或者使用 npx（无需全局安装）
# npx dotenv-cli

# 2. 在项目根目录执行
cd /Users/bd/Documents/selfdev/lifecode
npx dotenv-cli -e .env.local -- npx tsx scripts/migrate-normalized-birth-fields.ts
```

### 方式二：手动设置环境变量（Linux/Mac）

```bash
# 1. 进入项目目录
cd /Users/bd/Documents/selfdev/lifecode

# 2. 设置环境变量（从 .env.local 中获取值）
export NEXT_PUBLIC_SUPABASE_URL="your-supabase-url"
export SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"

# 3. 执行脚本
npx tsx scripts/migrate-normalized-birth-fields.ts
```

### 方式三：手动设置环境变量（Windows PowerShell）

```powershell
# 1. 进入项目目录
cd C:\path\to\lifecode

# 2. 设置环境变量
$env:NEXT_PUBLIC_SUPABASE_URL="your-supabase-url"
$env:SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"

# 3. 执行脚本
npx tsx scripts/migrate-normalized-birth-fields.ts
```

### 方式四：在脚本中直接读取 .env.local（最简单）

如果上述方式都不方便，我可以修改脚本直接读取 `.env.local` 文件。

## 获取环境变量值

环境变量值在 `.env.local` 文件中：

```bash
# 查看 .env.local（注意：不要提交到 git）
cat .env.local

# 或者
open .env.local
```

需要的两个变量：
- `NEXT_PUBLIC_SUPABASE_URL` - Supabase 项目 URL
- `SUPABASE_SERVICE_ROLE_KEY` - Supabase Service Role Key（在 Supabase Dashboard → Settings → API → service_role key）

## 执行输出示例

脚本执行时会显示进度：

```
开始批量更新档案的标准化字段...

找到 25 个需要更新的档案

进度: 10/25 (成功: 10, 失败: 0)
进度: 20/25 (成功: 20, 失败: 0)
进度: 25/25 (成功: 25, 失败: 0)

============================================================
批量更新完成！
总计: 25 个档案
成功: 25 个
失败: 0 个
============================================================

迁移完成！
```

## 常见问题

### 1. 找不到 tsx 命令

```bash
# 安装 tsx（TypeScript 执行器）
npm install -g tsx

# 或者使用 npx（推荐，无需全局安装）
npx tsx scripts/migrate-normalized-birth-fields.ts
```

### 2. 环境变量未设置

错误信息：`请设置环境变量：NEXT_PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY`

**解决方法**：
- 确保 `.env.local` 文件存在且包含这两个变量
- 或手动设置环境变量（见方式二/三）

### 3. 数据库连接失败

错误信息：`查询档案失败: ...`

**解决方法**：
- 检查 `NEXT_PUBLIC_SUPABASE_URL` 是否正确
- 检查 `SUPABASE_SERVICE_ROLE_KEY` 是否正确（注意：不是 `anon` key，而是 `service_role` key）
- 检查网络连接

### 4. 字段不存在错误

错误信息：`column "normalized_birth_date" does not exist`

**解决方法**：
- 先执行 SQL 迁移脚本 `add_normalized_birth_fields.sql`
- 确保 SQL 迁移已成功执行

## 验证结果

执行完成后，在 Supabase Dashboard 的 SQL Editor 中运行：

```sql
-- 检查有多少档案已填充标准化字段
SELECT 
  COUNT(*) as total,
  COUNT(normalized_birth_date) as with_normalized_date,
  COUNT(normalized_time_index) as with_normalized_time
FROM public."Archive";
```

如果 `with_normalized_date` 和 `with_normalized_time` 等于 `total`，说明所有档案都已成功更新。
