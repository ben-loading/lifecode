# 迁移完成后的步骤

## ✅ 已完成的工作

1. ✅ SQL 迁移：添加了 `normalized_birth_date` 和 `normalized_time_index` 字段
2. ✅ 创建索引：`idx_archive_normalized_birth` 用于快速查询
3. ✅ 批量更新：现有档案的标准化字段已填充

## 📋 后续步骤

### 1. 验证迁移结果（可选但推荐）

在 Supabase Dashboard 的 SQL Editor 中执行以下查询：

```sql
-- 检查所有档案是否都已填充标准化字段
SELECT 
  COUNT(*) as total,
  COUNT(normalized_birth_date) as with_normalized_date,
  COUNT(normalized_time_index) as with_normalized_time,
  COUNT(CASE WHEN normalized_birth_date IS NULL THEN 1 END) as missing_date,
  COUNT(CASE WHEN normalized_time_index IS NULL THEN 1 END) as missing_time
FROM public."Archive";

-- 查看一些示例数据
SELECT 
  id,
  name,
  gender,
  birth_date,
  normalized_birth_date,
  normalized_time_index
FROM public."Archive"
ORDER BY created_at DESC
LIMIT 10;
```

**预期结果**：
- `with_normalized_date` 和 `with_normalized_time` 应该等于 `total`
- `missing_date` 和 `missing_time` 应该为 0

### 2. 测试同命盘报告复用功能

#### 测试场景 1：主报告复用

1. **创建第一个档案**（档案A）
   - 填写出生信息（例如：2020-01-15，午时，男）
   - 创建档案并生成主报告
   - 等待报告生成完成

2. **创建第二个档案**（档案B，相同命盘）
   - 填写相同的出生信息（2020-01-15，午时，男）
   - 创建档案并生成主报告
   - **预期**：应该直接复用档案A的报告，不调用 LLM，节省成本

3. **验证结果**
   - 检查两个档案的报告内容是否完全一致
   - 检查后端日志，确认第二个档案没有调用 LLM

#### 测试场景 2：深度报告复用

1. **在档案A生成深度报告**
   - 进入深度解读页面
   - 点击生成"未来运势"报告
   - 等待报告生成完成

2. **在档案B生成相同类型的深度报告**
   - 进入深度解读页面
   - 点击生成"未来运势"报告
   - **预期**：应该直接复用档案A的报告，不调用 LLM

#### 测试场景 3：不同输入方式但相同命盘

1. **档案A**：公历 + 具体时刻 "2020-01-15T12:30:00" + 地点"北京"
2. **档案B**：公历 + 时辰 "2020-01-15" + 时辰"午时"
3. **预期**：两个档案应该匹配（都转换为相同的日期和时辰序号），复用报告

### 3. 监控和日志

#### 检查复用是否生效

在生成报告时，检查：
- **后端日志**：如果看到复用，应该没有 LLM 调用记录
- **数据库**：检查 `MainReport` 和 `DeepReport` 表，确认报告内容一致
- **用户侧**：用户仍然正常扣费，体验一致

#### 查看复用统计（可选）

可以添加日志记录复用次数，用于评估降本效果：

```sql
-- 查看有多少档案共享相同的命盘
SELECT 
  gender,
  normalized_birth_date,
  normalized_time_index,
  COUNT(*) as archive_count
FROM public."Archive"
WHERE normalized_birth_date IS NOT NULL
GROUP BY gender, normalized_birth_date, normalized_time_index
HAVING COUNT(*) > 1
ORDER BY archive_count DESC;
```

### 4. 代码已自动生效

✅ **新创建的档案**：会自动计算并存储标准化字段（通过 `createArchive` 函数）

✅ **报告生成**：会自动检测并复用相同命盘的报告（通过 `generateMainReport` 和 `generateDeepReport` 函数）

✅ **无需额外操作**：功能已集成到现有流程中

### 5. 注意事项

1. **数据一致性**：如果手动修改了档案的出生信息，标准化字段不会自动更新（需要手动触发更新或重新创建档案）

2. **报告版本**：如果报告生成逻辑更新，旧报告可能不适用新档案（当前方案是直接复用，后续可以考虑版本管理）

3. **跨用户复用**：当前实现允许跨用户复用报告（相同命盘的用户看到相同报告），这是预期行为

4. **性能监控**：建议监控 LLM 调用次数，评估降本效果

## 🎉 完成！

同命盘报告复用功能已完全实现并部署。现在：
- ✅ 相同命盘的用户会看到完全一致的报告
- ✅ 官方节省了 LLM 调用成本
- ✅ 用户侧体验保持一致（正常扣费）

可以开始测试验证了！
