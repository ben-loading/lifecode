# 兑换码后台管理系统使用说明

## 一、环境配置

### 1. 设置管理员邮箱

在 `.env.local` 或环境变量中配置管理员邮箱列表：

```bash
ADMIN_EMAILS=admin@example.com,another-admin@example.com
```

多个邮箱用逗号分隔，系统会自动识别这些邮箱为管理员。

### 2. 执行数据库迁移

在 Supabase Dashboard 的 SQL Editor 中执行：

```sql
-- 文件：migrations/add_redemption_code_fields.sql
ALTER TABLE public."RedemptionCode" 
ADD COLUMN IF NOT EXISTS "createdAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW();

ALTER TABLE public."RedemptionCode" 
ADD COLUMN IF NOT EXISTS "note" TEXT;

UPDATE public."RedemptionCode" 
SET "createdAt" = NOW() 
WHERE "createdAt" IS NULL;

CREATE INDEX IF NOT EXISTS "idx_redemption_code_created_at" 
ON public."RedemptionCode"("createdAt" DESC);

CREATE INDEX IF NOT EXISTS "idx_redemption_code_used_by" 
ON public."RedemptionCode"("usedBy") 
WHERE "usedBy" IS NOT NULL;
```

## 二、访问后台管理页面

1. **登录后台**：
   - 访问 `/admin/redemption-codes` 页面
   - 如果未登录，会自动弹出登录弹窗
   - 输入管理员邮箱，点击「发送验证码」
   - 输入收到的6位验证码，点击「登录」

2. **权限验证**：
   - 登录后系统会自动验证是否为管理员
   - 如果当前用户不是管理员，会显示错误提示并跳转到首页
   - 确保 `.env.local` 中配置了正确的 `ADMIN_EMAILS`

## 三、功能使用

### 1. 生成兑换码

1. 点击页面右上角的「生成兑换码」按钮
2. 在弹出的对话框中：
   - 输入能量值（必填，正整数）
   - 输入备注（可选，用于记录用途）
3. 点击「生成」按钮
4. 生成成功后，兑换码会自动复制到剪贴板

### 2. 查看兑换码列表

- 页面自动显示最近 50 条兑换码记录
- 显示信息包括：
  - 兑换码（可复制）
  - 能量值
  - 使用状态（未使用/已使用）
  - 创建时间
  - 备注
  - 使用者信息（如已使用）
  - 使用时间（如已使用）

### 3. 复制兑换码

- 点击兑换码右侧的「复制」按钮
- 兑换码会自动复制到剪贴板
- 复制成功后会显示「已复制」提示

### 4. 删除兑换码

- 只能删除未使用的兑换码
- 点击「删除」按钮
- 确认后删除
- 已使用的兑换码无法删除

## 四、兑换码格式

- **长度**：9 位
- **字符集**：大写字母（A-Z）+ 数字（2-9）
- **排除字符**：0、O、1、I（避免混淆）
- **示例**：`ABC123XYZ`, `K8M9N2P4Q`

## 五、API 接口

### POST /api/admin/redemption-codes
创建兑换码

**请求体**：
```json
{
  "amount": 200,
  "note": "活动赠送"
}
```

**响应**：
```json
{
  "code": "ABC123XYZ",
  "amount": 200,
  "createdAt": "2026-02-06T10:00:00Z"
}
```

### GET /api/admin/redemption-codes
查询兑换码列表

**查询参数**：
- `limit`: 每页数量（默认 20，最大 100）
- `offset`: 偏移量（默认 0）
- `includeUsed`: 是否包含已使用的（默认 true）

**响应**：
```json
{
  "codes": [
    {
      "code": "ABC123XYZ",
      "amount": 200,
      "usedBy": null,
      "usedAt": null,
      "createdAt": "2026-02-06T10:00:00Z",
      "note": "活动赠送"
    }
  ],
  "total": 100
}
```

### DELETE /api/admin/redemption-codes/[code]
删除未使用的兑换码

**响应**：
```json
{
  "success": true
}
```

## 六、安全说明

1. **权限控制**：所有后台 API 都需要管理员权限
2. **兑换码唯一性**：系统自动确保生成的兑换码不重复
3. **防重复使用**：兑换码使用后立即标记，防止重复使用
4. **删除限制**：只能删除未使用的兑换码，已使用的无法删除

## 七、注意事项

1. 确保在执行迁移前备份数据库
2. 管理员邮箱配置后需要重启应用才能生效
3. 兑换码生成后建议立即复制保存，避免丢失
4. 批量生成兑换码时，建议在备注中标注用途，便于后续管理
