# LifeCode äº§å“ä¸ç ”å‘æ€»ç»“

> **æœ€åæ›´æ–°**: 2026-01-29  
> **Git Commit**: `64c64e0` - feat: å®ç°å…¬å†/å†œå†ã€æ—¶è¾°/å…·ä½“æ—¶é—´è¾“å…¥ä¸çœŸå¤ªé˜³æ—¶æ ¡å‡†

---

## ğŸ“Š é¡¹ç›®æ¦‚è§ˆ

**LifeCode** æ˜¯ä¸€ä¸ªåŸºäºç´«å¾®æ–—æ•°ä¸å…«å­—å‘½ç†çš„æ™ºèƒ½å‘½ç†è§£è¯»å¹³å°ï¼Œé‡‡ç”¨ **iztro åº“** è¿›è¡Œæ’ç›˜è®¡ç®— + **LLMï¼ˆGPT-4o / DeepSeekï¼‰** ç”Ÿæˆè‡ªç„¶è¯­è¨€è§£è¯»ã€‚

### æ ¸å¿ƒä»·å€¼
- **ç²¾å‡†æ’ç›˜**ï¼šèŠ‚æ°”å››æŸ±å…«å­— + ç´«å¾®æ–—æ•°åŒæ ¸ç®—æ³•
- **çœŸå¤ªé˜³æ—¶æ ¡å‡†**ï¼šåŸºäºåœ°ç†ä½ç½®ä¿®æ­£æ—¶é—´åå·®
- **æ™ºèƒ½è§£è¯»**ï¼šLLM ç”Ÿæˆ 13 ä¸ªç»´åº¦çš„ä¸ªæ€§åŒ–å‘½ç†æŠ¥å‘Š
- **ç°ä»£ä½“éªŒ**ï¼šç®€çº¦è®¾è®¡ã€æµç•…äº¤äº’ã€å®æ—¶è¿›åº¦åé¦ˆ

---

## ğŸ¯ äº§å“åŠŸèƒ½ç°çŠ¶

### âœ… å·²å®ŒæˆåŠŸèƒ½

#### 1. ç”¨æˆ·ç³»ç»Ÿ
- [x] é‚®ç®± + éªŒè¯ç ç™»å½•ï¼ˆæ— å¯†ç ï¼‰
- [x] èƒ½é‡ç³»ç»Ÿï¼ˆæ–°ç”¨æˆ· 20 èƒ½é‡ï¼Œä¸»æŠ¥å‘Šæ¶ˆè€— 20ï¼‰
- [x] å¼€å‘ç¯å¢ƒä¸‹ç»ˆç«¯è¾“å‡ºéªŒè¯ç ï¼ˆ`[mock] send-code`ï¼‰
- [x] ç”¨æˆ· Context çŠ¶æ€ç®¡ç†

#### 2. å‡ºç”Ÿä¿¡æ¯è¾“å…¥ï¼ˆPhase 3 - æœ€æ–°å®Œæˆï¼‰
- [x] **å†åˆ¶é€‰æ‹©**ï¼šå…¬å† / å†œå†
- [x] **æ—¶é—´æ¨¡å¼**ï¼šå…·ä½“æ—¶é—´ / æ—¶è¾°é€‰æ‹©
- [x] **çœŸå¤ªé˜³æ—¶æ ¡å‡†**ï¼šç»çº¬åº¦ + Equation of Time ä¿®æ­£
- [x] **åŠ¨æ€è¡¨å•**ï¼š
  - å†œå†æ¨¡å¼æ˜¾ç¤ºå¹´/æœˆ/æ—¥ + é—°æœˆé€‰é¡¹
  - æ—¶è¾°æ¨¡å¼éšè—åœ°åŒºé€‰æ‹©ï¼ˆä»¥æ—¶è¾°ä¸­ç‚¹ä¸ºå‡†ï¼‰
  - å…·ä½“æ—¶é—´æ¨¡å¼å¿…å¡«åœ°åŒºï¼ˆç”¨äºæ ¡å‡†ï¼‰
- [x] **UI ä¼˜åŒ–**ï¼šå…‹åˆ¶ç®€çº¦é£æ ¼ï¼Œæ—  emojiï¼Œæ¸…æ™°å±‚çº§
- [x] **æ•°æ®éªŒè¯**ï¼šå‰åç«¯åŒé‡æ ¡éªŒå¿…å¡«å­—æ®µ

#### 3. å‘½ç›˜ç”Ÿæˆ
- [x] **iztro åº“é›†æˆ**ï¼š`yearDivide: 'exact', horoscopeDivide: 'exact'` ç¡®ä¿èŠ‚æ°”å››æŸ±
- [x] **bySolar / byLunar**ï¼šæ ¹æ®å†åˆ¶é€‰æ‹©è°ƒç”¨å¯¹åº”æ–¹æ³•
- [x] **æ—¶è¾°æ˜ å°„**ï¼šä¿®å¤ 23:00 -> æ™šå­æ—¶ï¼ˆindex=12ï¼‰çš„é”™è¯¯æ˜ å°„
- [x] **å‘½ç›˜å¯è§†åŒ–**ï¼š`/chart` é¡µé¢å±•ç¤ºç´«å¾®æ–—æ•°æ’ç›˜ï¼ˆ12 å®«ä½ + å››åŒ–ï¼‰

#### 4. ä¸»æŠ¥å‘Šç”Ÿæˆ
- [x] **å®Œæ•´æµç¨‹**ï¼šæ¡£æ¡ˆåˆ›å»º â†’ ä»»åŠ¡åˆ›å»º â†’ LLM ç”Ÿæˆ â†’ æŠ¥å‘Šå­˜å‚¨
- [x] **13 ä¸ª Section**ï¼š
  1. äººç”Ÿå‰§æœ¬ï¼ˆlifeScriptï¼‰
  2. æ ¸å¿ƒèƒ½åŠ›æ ‡ç­¾ï¼ˆcoreAbilityTagsï¼‰
  3. å‘½ç†åŸºç¡€ï¼ˆfoundationDataï¼‰
  4. é›·è¾¾å›¾ï¼ˆradarDataï¼Œ7 ç»´åº¦ï¼‰
  5. å¤šç»´è§£æï¼ˆdimensionDetailsï¼Œ7 ç»´åº¦ï¼‰
  6. æ€§æ ¼ç‰¹è´¨ï¼ˆpersonalityTraitsï¼Œ5-8 æ¡ï¼‰
  7. æ€§æ ¼æ ‡ç­¾ï¼ˆpersonalityLabelsï¼Œ8-12 ä¸ªï¼‰
  8. å®«ä½è§£æï¼ˆpalaceAnalysisï¼Œ5 ä¸ªå­æ¨¡å—ï¼‰
  9. èŒä¸šå¤©å‘½ï¼ˆcareerDestinyï¼‰
  10. äººç”Ÿå››é˜¶ï¼ˆlifeStagesï¼Œç«¥å¹´/é’å¹´/ä¸­å¹´/æ™šå¹´ï¼‰
  11. æµå¹´è¿åŠ¿å›¾è¡¨ï¼ˆyearlyFortuneChartï¼Œ30 å¹´æ•°æ®ï¼‰
  12. æµå¹´è¯¦ç»†æè¿°ï¼ˆyearlyDetailsï¼Œ3 ä¸ªå…³é”®å¹´ä»½ï¼‰
  13. ç¤¾äº¤åç‰‡ï¼ˆsocialCardï¼‰

- [x] **è¿›åº¦å±•ç¤º**ï¼š6 æ­¥éª¤ï¼ˆåˆ†ææ—¶è¾° â†’ å…«å­— â†’ æ’ç›˜ â†’ å…ˆå¤©å‘½ç›˜ â†’ å¤§é™æµå¹´ â†’ è¾“å‡ºè§£ç ï¼‰
- [x] **å‰ç«¯é©±åŠ¨è¿›åº¦**ï¼šè®¡æ—¶å™¨åˆ†é…æ—¶é—´ï¼ˆ10s + 10s + 12s + 13s + 25sï¼‰ï¼Œåç«¯ä»…è½®è¯¢å®ŒæˆçŠ¶æ€
- [x] **åŠ¨ç”»åé¦ˆ**ï¼šspinner åŠ è½½ã€æ­¥éª¤é«˜äº®ã€ç™¾åˆ†æ¯”è¿›åº¦

#### 5. æŠ€æœ¯æ¶æ„
- [x] **å‰ç«¯**ï¼šNext.js 15 + React 19 + TypeScript + Tailwind CSS
- [x] **åç«¯**ï¼šNext.js API Routes + å†…å­˜å­˜å‚¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- [x] **LLM é›†æˆ**ï¼š
  - OpenAI SDK æ”¯æŒ OpenAI / DeepSeek / è‡ªå®šä¹‰ baseURL
  - Prompt æ¨¡æ¿åŒ–ç³»ç»Ÿï¼ˆsystem.md + user-template.md + json-schema.jsonï¼‰
  - Zod Schema éªŒè¯ LLM è¾“å‡ºæ ¼å¼
- [x] **å‘½ç†è®¡ç®—**ï¼šiztro åº“ï¼ˆèŠ‚æ°”å››æŸ± + ç´«å¾®æ–—æ•°ï¼‰
- [x] **çœŸå¤ªé˜³æ—¶**ï¼šæ‰‹åŠ¨è®¡ç®—ï¼ˆiztro ä¸æ”¯æŒï¼ŒåŸºäºç»åº¦ + EoTï¼‰

---

## ğŸ› ï¸ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ ¸å¿ƒæœåŠ¡å±‚

| æœåŠ¡ | æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|------|
| **iztro-service** | `src/lib/services/iztro-service.ts` | å‘½ç›˜è®¡ç®—ã€bySolar/byLunar è°ƒç”¨ã€çœŸå¤ªé˜³æ—¶æ ¡å‡† |
| **prompt-builder** | `src/lib/services/prompt-builder.ts` | åŠ è½½ Prompt æ¨¡æ¿ã€å˜é‡æ›¿æ¢ |
| **llm-service** | `src/lib/services/llm-service.ts` | OpenAI API è°ƒç”¨ã€æµå¼/éæµå¼æ”¯æŒ |
| **report-validator** | `src/lib/services/report-validator.ts` | Zod Schema éªŒè¯ã€JSON æå–ä¸è§„èŒƒåŒ– |
| **report-service** | `src/lib/services/report-service.ts` | ä¸»æŠ¥å‘Šç”Ÿæˆä¸»æµç¨‹ï¼ˆæ•´åˆä¸Šè¿°æ‰€æœ‰æ­¥éª¤ï¼‰ |

### æ•°æ®æ¨¡å‹

```typescript
// æ ¸å¿ƒç±»å‹
interface ApiArchive {
  id: string
  name: string
  gender: 'male' | 'female'
  birthDate: string              // ISO 8601 æ ¼å¼
  birthLocation: string          // "ä¸­å›½,åŒ—äº¬å¸‚"
  birthCalendar?: 'solar' | 'lunar'
  birthTimeMode?: 'datetime' | 'shichen'
  birthTimeBranch?: number       // 0-12ï¼ˆæ—¶è¾° indexï¼‰
  lunarDate?: string             // "1990-8-15"ï¼ˆå†œå†æ—¥æœŸï¼‰
  isLeapMonth?: boolean
  createdAt: string
}

interface MainReportContent {
  lifeScript: { title: string; summary: string; content: string }
  coreAbilityTags: string[]
  foundationData: { å…«å­—: string; å‘½å®«ä¸»æ˜Ÿ: string; èº«å®«ä¸»æ˜Ÿ: string; äº”è¡Œ: string }
  radarData: [number, number, number, number, number, number, number]
  dimensionDetails: Array<{ dimension: string; score: number; description: string }>
  personalityTraits: Array<{ trait: string; percentage: number; description: string }>
  personalityLabels: string[]
  palaceAnalysis: { ... }  // 5 ä¸ªå­æ¨¡å—
  careerDestiny: { ... }   // èŒä¸šå¤©å‘½
  lifeStages: Array<{ stage: string; ageRange: string; description: string }>
  yearlyFortuneChart: Array<{ year: number; fortune: number }>
  yearlyDetails: Array<{ year: number; isHighlight: boolean; title: string; content: string }>
  socialCard: { title: string; subtitle: string; tags: string[] }
}
```

### çœŸå¤ªé˜³æ—¶æ ¡å‡†ç®—æ³•

```typescript
// src/lib/birth-constants.ts
function getSolarTimeOffsetMinutes(longitude: number, solarDate: string): number {
  const centralLong = 120  // UTC+8 ä¸­å¤®ç»çº¿
  const longitudeOffset = (longitude - centralLong) * 4  // æ¯åº¦ 4 åˆ†é’Ÿ

  // Equation of Timeï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨ 365 å¤©è¿‘ä¼¼ï¼‰
  const date = new Date(solarDate)
  const dayOfYear = Math.floor((date.getTime() - new Date(date.getFullYear(), 0, 0).getTime()) / 86400000)
  const B = (2 * Math.PI * (dayOfYear - 81)) / 365
  const EoT = 9.87 * Math.sin(2 * B) - 7.53 * Math.cos(B) - 1.5 * Math.sin(B)

  return Math.round(longitudeOffset + EoT)
}
```

**åº”ç”¨**ï¼š
- `datetime` æ¨¡å¼ï¼š`birthDate` æ—¶é—´ + `getSolarTimeOffsetMinutes()` â†’ è°ƒæ•´åçš„ `hour` â†’ `hourToTimeIndex()`
- `shichen` æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨ `birthTimeBranch`ï¼ˆ0-12ï¼‰ï¼Œæ— éœ€æ ¡å‡†

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
lifecode/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ archives/route.ts          # æ¡£æ¡ˆ CRUD
â”‚   â”‚   â”‚   â”œâ”€â”€ report/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ generate/route.ts      # ç”Ÿæˆä¸»æŠ¥å‘Š
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ [archiveId]/route.ts  # è·å–æŠ¥å‘Š
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ status/[jobId]/route.ts
â”‚   â”‚   â”‚   â””â”€â”€ debug/store/route.ts       # è°ƒè¯•æ¥å£ï¼ˆå†…å­˜å­˜å‚¨çŠ¶æ€ï¼‰
â”‚   â”‚   â”œâ”€â”€ page.tsx                       # é¦–é¡µ
â”‚   â”‚   â”œâ”€â”€ chart/page.tsx                 # å‘½ç›˜å¯è§†åŒ–
â”‚   â”‚   â””â”€â”€ report/page.tsx                # ä¸»æŠ¥å‘Šå±•ç¤ºé¡µ
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ input-page.tsx                 # å‡ºç”Ÿä¿¡æ¯è¾“å…¥ï¼ˆæœ€æ–°ä¼˜åŒ–ï¼‰
â”‚   â”‚   â”œâ”€â”€ archive-page.tsx               # æ¡£æ¡ˆåˆ›å»º
â”‚   â”‚   â”œâ”€â”€ date-time-picker.tsx           # æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨
â”‚   â”‚   â””â”€â”€ region-select.tsx              # åœ°åŒºé€‰æ‹©å™¨
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ services/                      # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ prompts/                       # LLM Prompt æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ types/                         # TypeScript ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ birth-constants.ts             # æ—¶è¾°å¸¸é‡ + å¤ªé˜³æ—¶æ ¡å‡†
â”‚   â”‚   â”œâ”€â”€ context.tsx                    # å…¨å±€çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ store.ts                       # å†…å­˜å­˜å‚¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
â”‚   â”‚   â””â”€â”€ api-client.ts                  # API å®¢æˆ·ç«¯
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ simulate-report-generation.ts      # æ¨¡æ‹ŸæŠ¥å‘Šç”Ÿæˆï¼ˆæµ‹è¯•ï¼‰
â”‚   â””â”€â”€ validate-report-format.ts          # éªŒè¯ LLM è¾“å‡ºæ ¼å¼
â”œâ”€â”€ test-output/                           # æµ‹è¯•è¾“å‡ºæ–‡ä»¶
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ PROGRESS.md                        # ç ”å‘è¿›åº¦è¯¦ç»†è®°å½•
â”‚   â”œâ”€â”€ SUMMARY.md                         # æœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ CONFIG.md                          # ç¯å¢ƒé…ç½®è¯´æ˜
â”‚   â””â”€â”€ *.json / *.md                      # ç¤ºä¾‹æ•°æ®ä¸è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma                      # æ•°æ®åº“ Schemaï¼ˆæœªå¯ç”¨ï¼‰
â”œâ”€â”€ package.json
â””â”€â”€ .env.local.example                     # ç¯å¢ƒå˜é‡æ¨¡æ¿
```

---

## ğŸ”§ ç¯å¢ƒé…ç½®

### å¿…éœ€é…ç½®

```bash
# .env.local
OPENAI_API_KEY=sk-xxx          # OpenAI API Key
# æˆ–
DEEPSEEK_API_KEY=sk-xxx        # DeepSeek API Key
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1

# å¯é€‰
DATABASE_URL=postgresql://...  # PostgreSQL è¿æ¥ï¼ˆå½“å‰ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼‰
```

### å¯åŠ¨é¡¹ç›®

```bash
npm install
npm run dev
```

è®¿é—® `http://localhost:3000`

---

## ğŸ“ˆ å½“å‰è¿›åº¦è¯„ä¼°

### âœ… å·²å®Œæˆï¼ˆPhase 1-3ï¼‰

| é˜¶æ®µ | å†…å®¹ | å®Œæˆåº¦ |
|------|------|--------|
| **Phase 1** | åŸºç¡€æ¶æ„ + ç”¨æˆ·ç™»å½• + æ¡£æ¡ˆç®¡ç† | 100% |
| **Phase 2** | ä¸»æŠ¥å‘Šç”Ÿæˆï¼ˆLLM + iztro é›†æˆï¼‰ | 100% |
| **Phase 3** | å…¬å†/å†œå† + æ—¶è¾°/å…·ä½“æ—¶é—´ + çœŸå¤ªé˜³æ—¶æ ¡å‡† | 100% |

### ğŸš§ è¿›è¡Œä¸­ï¼ˆPhase 4ï¼‰

- [ ] **LLM è¾“å‡ºè´¨é‡ä¼˜åŒ–**ï¼š
  - å½“å‰ Prompt å·²ç»è¿‡å¤šè½®è¿­ä»£ï¼Œèƒ½ç”Ÿæˆç¬¦åˆæ ¼å¼çš„ JSON
  - ä½†éƒ¨åˆ†å­—æ®µï¼ˆå¦‚ `palaceAnalysis` çš„æè¿°ï¼‰ä»æœ‰é‡å¤è¯æ±‡æˆ–å†—ä½™
  - éœ€è¦æ›´å¤šçœŸå®æ¡ˆä¾‹æµ‹è¯•å’Œ Prompt å¾®è°ƒ

- [ ] **å‰ç«¯ç»†èŠ‚æ‰“ç£¨**ï¼š
  - æŠ¥å‘Šé¡µæ»šåŠ¨ä½“éªŒä¼˜åŒ–ï¼ˆé”šç‚¹å¯¼èˆªï¼‰
  - ç§»åŠ¨ç«¯é€‚é…ï¼ˆå½“å‰å·²å“åº”å¼ï¼Œä½†å¯è¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰
  - å‘½ç›˜å¯è§†åŒ–å¢å¼ºï¼ˆé£æ˜Ÿã€å››åŒ–é«˜äº®ï¼‰

### ğŸ“ å¾…å¼€å‘ï¼ˆPhase 5+ï¼‰

#### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
- [ ] **æ•°æ®åº“è¿ç§»**ï¼šä»å†…å­˜å­˜å‚¨è¿ç§»åˆ° PostgreSQLï¼ˆPrismaï¼‰
- [ ] **æ·±åº¦æŠ¥å‘Š**ï¼š4 ç±»æ·±åº¦æŠ¥å‘Šï¼ˆäº‹ä¸š/è´¢å¯Œ/æƒ…æ„Ÿ/å¥åº·ï¼‰ï¼Œæ¯ç±»ç‹¬ç«‹ Prompt
- [ ] **é”™è¯¯å¤„ç†å¢å¼º**ï¼šå‰ç«¯å‹å¥½æç¤º + é‡è¯•æœºåˆ¶
- [ ] **æµ‹è¯•è¦†ç›–**ï¼šå•å…ƒæµ‹è¯•ï¼ˆæœåŠ¡å±‚ï¼‰+ E2E æµ‹è¯•ï¼ˆæŠ¥å‘Šç”Ÿæˆæµç¨‹ï¼‰

#### ä¸­æœŸï¼ˆ1 ä¸ªæœˆï¼‰
- [ ] **èƒ½é‡å……å€¼ç³»ç»Ÿ**ï¼š
  - æ”¯ä»˜é›†æˆï¼ˆå¾®ä¿¡/æ”¯ä»˜å®ï¼‰
  - å…‘æ¢ç ç³»ç»Ÿï¼ˆå·²æœ‰ Prisma Schemaï¼‰
  - é‚€è¯·å¥–åŠ±æœºåˆ¶
- [ ] **æ¡£æ¡ˆç®¡ç†ä¼˜åŒ–**ï¼š
  - å¤šæ¡£æ¡ˆåˆ‡æ¢
  - æ¡£æ¡ˆåˆ é™¤/ç¼–è¾‘
  - å†å²æŠ¥å‘ŠæŸ¥çœ‹
- [ ] **ç¤¾äº¤åˆ†äº«**ï¼š
  - ç”Ÿæˆç¤¾äº¤åç‰‡å›¾ç‰‡
  - åˆ†äº«åˆ°å¾®ä¿¡/æœ‹å‹åœˆ
  - é‚€è¯·é“¾æ¥æœºåˆ¶

#### é•¿æœŸï¼ˆ3 ä¸ªæœˆ+ï¼‰
- [ ] **æµå¼ç”Ÿæˆ**ï¼šSSE/WebSocket å®æ—¶å±•ç¤º LLM ç”Ÿæˆè¿›åº¦
- [ ] **å¤šè¯­è¨€æ”¯æŒ**ï¼šç¹ä½“ä¸­æ–‡/è‹±æ–‡ Prompt æ¨¡æ¿
- [ ] **ç¼“å­˜ä¼˜åŒ–**ï¼šç›¸åŒå‘½ç›˜é¿å…é‡å¤è°ƒç”¨ LLM
- [ ] **ç›‘æ§ä¸æ—¥å¿—**ï¼šLLM è°ƒç”¨æˆåŠŸç‡ã€è€—æ—¶ç»Ÿè®¡ã€é”™è¯¯è¿½è¸ª
- [ ] **ä¸ªæ€§åŒ–æ¨è**ï¼šåŸºäºç”¨æˆ·å‘½ç›˜æ¨èæ·±åº¦æŠ¥å‘Šä¸»é¢˜
- [ ] **AI å¯¹è¯**ï¼šåŸºäºæŠ¥å‘Šå†…å®¹çš„æ™ºèƒ½é—®ç­”

---

## ğŸ› å·²çŸ¥é—®é¢˜

### æŠ€æœ¯å€ºåŠ¡
1. **å†…å­˜å­˜å‚¨**ï¼šå½“å‰ä½¿ç”¨ `src/lib/store.ts` å†…å­˜å­˜å‚¨ï¼Œé‡å¯æœåŠ¡æ•°æ®ä¸¢å¤±
   - **è§£å†³æ–¹æ¡ˆ**ï¼šè¿ç§»åˆ° PostgreSQL + Prismaï¼ˆå·²å‡†å¤‡å¥½ Schemaï¼‰

2. **Node.js ç‰ˆæœ¬**ï¼šPrisma 7.x è¦æ±‚ Node.js >= 20.19ï¼Œå½“å‰ v21.4.0
   - **è§£å†³æ–¹æ¡ˆ**ï¼šå‡çº§åˆ° Node.js 22.12+ LTS

3. **LLM è¾“å‡ºç¨³å®šæ€§**ï¼šå¶å°”å‡ºç°æ ¼å¼é”™è¯¯æˆ–å­—æ®µç¼ºå¤±
   - **å½“å‰ç¼“è§£**ï¼š`report-validator.ts` ä¸­çš„ `normalizeMainReportOutput()` ä¿®å¤å¸¸è§é—®é¢˜
   - **æ ¹æœ¬æ–¹æ¡ˆ**ï¼šæŒç»­ä¼˜åŒ– Prompt + å¢åŠ  few-shot examples

### UI/UX ç»†èŠ‚
1. **è¾“å…¥é¡µéªŒè¯æç¤º**ï¼šå½“å‰åªæœ‰ç¦ç”¨æŒ‰é’®ï¼Œå¯å¢åŠ å…·ä½“é”™è¯¯æç¤º
2. **æŠ¥å‘Šé¡µåŠ è½½çŠ¶æ€**ï¼š70s æµç¨‹è¾ƒé•¿ï¼Œå¯å¢åŠ "é¢„è®¡æ—¶é—´"æç¤º
3. **å‘½ç›˜é¡µäº¤äº’**ï¼šå½“å‰ä¸ºé™æ€å±•ç¤ºï¼Œå¯å¢åŠ å®«ä½ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡ï¼ˆå½“å‰æµ‹è¯•æ•°æ®ï¼‰

| æŒ‡æ ‡ | æ•°æ® | è¯´æ˜ |
|------|------|------|
| **iztro è®¡ç®—æ—¶é—´** | < 100ms | æœ¬åœ°è®¡ç®—ï¼Œå‡ ä¹ç¬æ—¶ |
| **LLM è°ƒç”¨æ—¶é—´** | 40-60s | DeepSeek v3 / GPT-4oï¼Œéæµå¼ |
| **æ€»æµç¨‹æ—¶é—´** | ~70s | åŒ…å«å‰ç«¯è¿›åº¦æ¨¡æ‹Ÿ + LLM ç”Ÿæˆ |
| **Token æ¶ˆè€—** | ~8000-12000 tokens | è¾“å…¥ ~3000 + è¾“å‡º ~5000-9000 |
| **æˆæœ¬ä¼°ç®—** | Â¥0.05-0.1 / æ¬¡ | åŸºäº DeepSeek å®šä»·ï¼ˆ$0.014/1M output tokensï¼‰ |

---

## ğŸ“ æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹

### 1. é…ç½®åŒ– Prompt ç³»ç»Ÿ
**ä½ç½®**: `src/lib/prompts/main-report/`

**ç‰¹ç‚¹**:
- Prompt å­˜å‚¨åœ¨ç‹¬ç«‹æ–‡ä»¶ï¼ˆMarkdown + JSONï¼‰ï¼Œä¿®æ”¹æ— éœ€é‡å¯
- æ”¯æŒå˜é‡æ›¿æ¢ï¼ˆå¦‚ `{{IZTRO_INPUT}}`ï¼‰
- ä¾¿äº A/B æµ‹è¯•å’Œç‰ˆæœ¬ç®¡ç†

**æ–‡ä»¶ç»“æ„**:
```
main-report/
â”œâ”€â”€ system.md          # è§’è‰²è®¾å®š + åˆ†ææ–¹æ³•è®º
â”œâ”€â”€ user-template.md   # ç”¨æˆ·æ¶ˆæ¯æ¨¡æ¿
â”œâ”€â”€ json-schema.json   # è¾“å‡º JSON Schema çº¦æŸ
â””â”€â”€ config.json        # æ¨¡å‹é…ç½®ï¼ˆtemperature, maxTokensï¼‰
```

### 2. åŒæ ¸ç®—æ³•å°è£…
**å…«å­—ï¼ˆ60%ï¼‰+ ç´«å¾®æ–—æ•°ï¼ˆ40%ï¼‰**

**å®ç°**:
- `iztro-service.ts` ç”Ÿæˆæ ‡å‡†åŒ–çš„ `IztroInput` æ ¼å¼
- Prompt ä¸­åµŒå…¥æƒé‡è®¡ç®—æ–¹æ³•è®º
- LLM æ ¹æ®ä¸¤å¥—ç³»ç»Ÿç»¼åˆåˆ†æ

### 3. ä¸¥æ ¼çš„ç±»å‹çº¦æŸ
**TypeScript + Zod åŒé‡ä¿éšœ**

```typescript
// ç±»å‹å®šä¹‰
export interface MainReportContent { ... }

// Zod Schema
export const MainReportSchema = z.object({
  lifeScript: z.object({
    title: z.string().max(30),
    summary: z.string().min(50).max(120),
    content: z.string().min(300).max(800)
  }),
  // ...
})
```

**å¥½å¤„**:
- å›ºå®šé•¿åº¦æ•°ç»„ï¼ˆradarData=7, lifeStages=4ï¼‰ç¡®ä¿å‰ç«¯æ¸²æŸ“ç¨³å®š
- æšä¸¾å€¼çº¦æŸï¼ˆgender, stageï¼‰é¿å…éæ³•æ•°æ®
- å­—ç¬¦ä¸²é•¿åº¦é™åˆ¶é˜²æ­¢ LLM ç”Ÿæˆè¿‡é•¿/è¿‡çŸ­å†…å®¹

### 4. çœŸå¤ªé˜³æ—¶ç²¾å‡†æ ¡å‡†
**é—®é¢˜**: iztro åº“ä¸æ”¯æŒç»çº¬åº¦æ ¡å‡†

**è§£å†³æ–¹æ¡ˆ**:
1. æ‰‹åŠ¨è®¡ç®—ç»åº¦åç§»ï¼ˆç›¸å¯¹ UTC+8 ä¸­å¤®ç»çº¿ 120Â°ï¼‰
2. åŠ å…¥ Equation of Time ä¿®æ­£ï¼ˆåœ°çƒå…¬è½¬æ¤­åœ†è½¨é“å¯¼è‡´çš„æ—¶å·®ï¼‰
3. è°ƒæ•´ `birthDate` æ—¶é—´åå†è°ƒç”¨ iztro

**ç²¾åº¦**: Â±5 åˆ†é’Ÿï¼ˆå— EoT ç®€åŒ–ç®—æ³•å½±å“ï¼‰

---

## ğŸ“š å¼€å‘è€…æŒ‡å—

### å¦‚ä½•æ·»åŠ æ–°çš„æŠ¥å‘Šç±»å‹ï¼Ÿ

1. **å®šä¹‰ç±»å‹**: `src/lib/types/xxx-report.ts`
2. **åˆ›å»º Prompt**: `src/lib/prompts/xxx-report/`
3. **å®ç°æœåŠ¡**: åœ¨ `report-service.ts` ä¸­æ·»åŠ  `generateXxxReport()`
4. **æ·»åŠ  API**: `src/app/api/report/xxx/route.ts`
5. **å‰ç«¯å±•ç¤º**: åˆ›å»ºå¯¹åº”é¡µé¢ç»„ä»¶

### å¦‚ä½•è°ƒè¯• LLM è¾“å‡ºï¼Ÿ

1. **æŸ¥çœ‹æµ‹è¯•è¾“å‡º**: `test-output/` ç›®å½•åŒ…å«å®Œæ•´çš„ Prompt å’Œ LLM å“åº”
2. **ä½¿ç”¨è°ƒè¯•æ¥å£**: `GET /api/debug/store` æŸ¥çœ‹å†…å­˜æ•°æ®
3. **è¿è¡Œæ¨¡æ‹Ÿè„šæœ¬**:
   ```bash
   npx tsx scripts/simulate-report-generation.ts
   npx tsx scripts/validate-report-format.ts
   ```

### å¦‚ä½•ä¼˜åŒ– Promptï¼Ÿ

1. ç¼–è¾‘ `src/lib/prompts/main-report/system.md`ï¼ˆä¿®æ”¹åˆ†æé€»è¾‘ï¼‰
2. ç¼–è¾‘ `json-schema.json`ï¼ˆè°ƒæ•´å­—æ®µçº¦æŸï¼‰
3. è°ƒæ•´ `config.json` ä¸­çš„ `temperature`ï¼ˆé™ä½å¯æé«˜ä¸€è‡´æ€§ï¼‰
4. è¿è¡Œ `simulate-report-generation.ts` æµ‹è¯•æ–° Prompt
5. å¯¹æ¯” `test-output/validation-report.md` æŸ¥çœ‹å·®å¼‚

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç”Ÿäº§ç¯å¢ƒ Checklist

- [ ] è¿ç§»åˆ° PostgreSQL æ•°æ®åº“
- [ ] é…ç½® Redis ç¼“å­˜ï¼ˆå‡å°‘é‡å¤ LLM è°ƒç”¨ï¼‰
- [ ] è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆAPI Key, Database URLï¼‰
- [ ] å¯ç”¨æ—¥å¿—ç›‘æ§ï¼ˆSentry / LogRocketï¼‰
- [ ] é…ç½® CDNï¼ˆé™æ€èµ„æºåŠ é€Ÿï¼‰
- [ ] å®ç°é™æµæœºåˆ¶ï¼ˆé˜²æ­¢æ»¥ç”¨ APIï¼‰
- [ ] å¤‡ä»½ç­–ç•¥ï¼ˆæ•°æ®åº“å®šæœŸå¤‡ä»½ï¼‰
- [ ] HTTPS è¯ä¹¦é…ç½®

### æ¨èæŠ€æœ¯æ ˆ

- **æ‰˜ç®¡å¹³å°**: Vercelï¼ˆNext.js åŸç”Ÿæ”¯æŒï¼‰
- **æ•°æ®åº“**: Supabase / Neonï¼ˆPostgreSQLï¼‰
- **ç¼“å­˜**: Upstash Redis
- **ç›‘æ§**: Vercel Analytics + Sentry
- **æ”¯ä»˜**: Stripeï¼ˆå›½é™…ï¼‰/ å¾®ä¿¡æ”¯ä»˜ï¼ˆå›½å†…ï¼‰

---

## ğŸ“ åç»­è§„åˆ’

### Q1 2026ï¼ˆå½“å‰å­£åº¦ï¼‰
- [x] Phase 1-3ï¼šåŸºç¡€åŠŸèƒ½ + ä¸»æŠ¥å‘Šç”Ÿæˆ + çœŸå¤ªé˜³æ—¶æ ¡å‡†
- [ ] Phase 4ï¼šæ·±åº¦æŠ¥å‘Š + æ•°æ®åº“è¿ç§»
- [ ] Phase 5ï¼šèƒ½é‡å……å€¼ç³»ç»Ÿ + ç¤¾äº¤åˆ†äº«

### Q2 2026
- [ ] æµå¼ç”Ÿæˆä½“éªŒä¼˜åŒ–
- [ ] å¤šè¯­è¨€æ”¯æŒï¼ˆç¹ä¸­/è‹±æ–‡ï¼‰
- [ ] AI å¯¹è¯åŠŸèƒ½ï¼ˆåŸºäºæŠ¥å‘Šå†…å®¹çš„æ™ºèƒ½é—®ç­”ï¼‰

### Q3 2026
- [ ] ç§»åŠ¨ç«¯ Appï¼ˆReact Nativeï¼‰
- [ ] å¾®ä¿¡å°ç¨‹åºç‰ˆæœ¬
- [ ] ä¼šå‘˜è®¢é˜…åˆ¶

---

## ğŸ™ æŠ€æœ¯ä¾èµ–

| ä¾èµ– | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Next.js | 15.1.6 | å…¨æ ˆæ¡†æ¶ |
| React | 19.0.0 | UI æ¡†æ¶ |
| TypeScript | 5.x | ç±»å‹å®‰å…¨ |
| iztro | 2.4.10 | å‘½ç†è®¡ç®—ï¼ˆç´«å¾®æ–—æ•° + å…«å­—ï¼‰ |
| openai | 4.77.3 | LLM API å®¢æˆ·ç«¯ |
| zod | 3.24.1 | è¿è¡Œæ—¶ç±»å‹éªŒè¯ |
| Tailwind CSS | 3.4.1 | æ ·å¼æ¡†æ¶ |
| Prisma | 7.x | ORMï¼ˆå¾…å¯ç”¨ï¼‰ |

---

## ğŸ“ æ€»ç»“

### å½“å‰çŠ¶æ€
âœ… **äº§å“æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ**ï¼Œå¯è¿›è¡Œå®Œæ•´çš„ç”¨æˆ·ä½“éªŒæµç¨‹ï¼š
1. ç™»å½• â†’ 2. è¾“å…¥å‡ºç”Ÿä¿¡æ¯ â†’ 3. ç”Ÿæˆä¸»æŠ¥å‘Š â†’ 4. æŸ¥çœ‹å®Œæ•´ 13 ä¸ª Section

âœ… **æŠ€æœ¯æ¶æ„ç¨³å®š**ï¼Œåˆ†å±‚æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•

âœ… **ä»£ç è´¨é‡**ï¼šTypeScript å…¨è¦†ç›–ï¼ŒZod éªŒè¯ï¼ŒGit è§„èŒƒæäº¤

### ä¸‹ä¸€æ­¥é‡ç‚¹
1. **æµ‹è¯•çœŸå® LLM è°ƒç”¨**ï¼ˆé…ç½® API Key åæµ‹è¯•å®Œæ•´æµç¨‹ï¼‰
2. **LLM è¾“å‡ºè´¨é‡ä¼˜åŒ–**ï¼ˆæ”¶é›†çœŸå®æ¡ˆä¾‹ï¼Œè¿­ä»£ Promptï¼‰
3. **æ•°æ®åº“è¿ç§»**ï¼ˆä»å†…å­˜å­˜å‚¨åˆ‡æ¢åˆ° PostgreSQLï¼‰

### æŠ€æœ¯äº®ç‚¹
- **çœŸå¤ªé˜³æ—¶æ ¡å‡†**ï¼šæ‰‹åŠ¨å®ç°ç»åº¦ + EoT ä¿®æ­£ï¼ˆiztro ä¸æ”¯æŒï¼‰
- **é…ç½®åŒ– Prompt**ï¼šæ¨¡æ¿åŒ–ç®¡ç†ï¼Œæ”¯æŒçƒ­æ›´æ–°å’Œ A/B æµ‹è¯•
- **åŒæ ¸ç®—æ³•**ï¼šå…«å­— 60% + ç´«å¾® 40% ç»¼åˆè§£è¯»
- **ç±»å‹å®‰å…¨**ï¼šTypeScript + Zod åŒé‡ä¿éšœï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯

---

**Git Commit**: `64c64e0`  
**æäº¤ä¿¡æ¯**: feat: å®ç°å…¬å†/å†œå†ã€æ—¶è¾°/å…·ä½“æ—¶é—´è¾“å…¥ä¸çœŸå¤ªé˜³æ—¶æ ¡å‡†

**å˜æ›´ç»Ÿè®¡**:
- 52 ä¸ªæ–‡ä»¶å˜æ›´
- +10,589 è¡Œæ–°å¢
- -254 è¡Œåˆ é™¤
- æ¶‰åŠæ ¸å¿ƒåŠŸèƒ½ï¼šå‡ºç”Ÿä¿¡æ¯è¾“å…¥ã€iztro æœåŠ¡å±‚ã€æŠ¥å‘Šç”Ÿæˆæµç¨‹ã€å‰ç«¯ UI ä¼˜åŒ–

**ä¸‹æ¬¡å¼€å‘ç»§ç»­ç‚¹**:
1. é…ç½® `.env.local`ï¼ˆå¤åˆ¶ `.env.local.example`ï¼Œå¡«å†™ API Keyï¼‰
2. æµ‹è¯•å®Œæ•´æµç¨‹ï¼š`npm run dev` â†’ ç™»å½• â†’ è¾“å…¥ä¿¡æ¯ â†’ ç”ŸæˆæŠ¥å‘Š
3. æ£€æŸ¥ `test-output/` ç›®å½•éªŒè¯ LLM è¾“å‡ºè´¨é‡
4. æ ¹æ®æµ‹è¯•ç»“æœä¼˜åŒ– Promptï¼ˆ`src/lib/prompts/main-report/system.md`ï¼‰
