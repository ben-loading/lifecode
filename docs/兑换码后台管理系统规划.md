# 兑换码后台管理系统规划

## 一、功能需求

### 核心功能
1. **生成兑换码**
   - 设置赠送能量值（必填）
   - 自动生成唯一兑换码（格式：大写字母+数字，如 `ABC123XYZ`）
   - 可选：添加备注/说明

2. **查看兑换码列表**
   - 显示兑换码、能量值、创建时间
   - 显示使用状态（未使用/已使用）
   - 显示使用者和使用时间（如已使用）
   - 支持分页或滚动加载

3. **管理兑换码**（可选）
   - 删除未使用的兑换码
   - 禁用兑换码（标记为无效）

## 二、数据库设计

### 当前表结构（RedemptionCode）
```sql
- code: string (主键，大写)
- amount: number (能量值)
- usedBy: string? (使用者ID，null表示未使用)
- usedAt: string? (使用时间，ISO格式)
```

### 建议扩展字段（可选）
```sql
- createdAt: string (创建时间)
- createdBy: string? (创建者ID，可选)
- note: string? (备注/说明，可选)
- isActive: boolean (是否有效，默认true，用于禁用)
```

## 三、技术实现方案

### 1. 数据库层 (`src/lib/db.ts`)

#### 新增函数
```typescript
// 创建兑换码
export async function createRedemptionCode(params: {
  code: string
  amount: number
  createdBy?: string
  note?: string
}): Promise<void>

// 查询兑换码列表
export async function listRedemptionCodes(params?: {
  limit?: number
  offset?: number
  includeUsed?: boolean
}): Promise<Array<{
  code: string
  amount: number
  usedBy?: string
  usedAt?: string
  createdAt?: string
  note?: string
}>>

// 删除兑换码（仅未使用的）
export async function deleteRedemptionCode(code: string): Promise<void>
```

### 2. API 接口

#### `POST /api/admin/redemption-codes`
**功能**：创建兑换码
**请求体**：
```json
{
  "amount": 200,
  "note": "活动赠送"
}
```
**响应**：
```json
{
  "code": "ABC123XYZ",
  "amount": 200,
  "createdAt": "2026-02-06T10:00:00Z"
}
```

#### `GET /api/admin/redemption-codes`
**功能**：查询兑换码列表
**查询参数**：
- `limit`: 每页数量（默认20）
- `offset`: 偏移量（默认0）
- `includeUsed`: 是否包含已使用的（默认true）
**响应**：
```json
{
  "codes": [
    {
      "code": "ABC123XYZ",
      "amount": 200,
      "usedBy": null,
      "usedAt": null,
      "createdAt": "2026-02-06T10:00:00Z",
      "note": "活动赠送"
    }
  ],
  "total": 100
}
```

#### `DELETE /api/admin/redemption-codes/[code]`（可选）
**功能**：删除未使用的兑换码
**响应**：
```json
{
  "success": true
}
```

### 3. 权限控制

#### 方案一：环境变量配置管理员邮箱（简单）
```typescript
// src/lib/auth-server.ts
const ADMIN_EMAILS = (process.env.ADMIN_EMAILS || '').split(',').map(e => e.trim().toLowerCase())

export async function isAdmin(userId: string): Promise<boolean> {
  const user = await getUserById(userId)
  if (!user) return false
  return ADMIN_EMAILS.includes(user.email.toLowerCase())
}
```

#### 方案二：数据库用户角色字段（更灵活）
- 在 `User` 表中添加 `role` 字段（`'user' | 'admin'`）
- 查询时检查用户角色

**推荐方案一**（简单快速，适合初期）

### 4. 前端页面

#### 路径：`/admin/redemption-codes`
**页面结构**：
```
┌─────────────────────────────────────┐
│  兑换码管理                          │
├─────────────────────────────────────┤
│  [生成兑换码] 按钮                   │
├─────────────────────────────────────┤
│  兑换码列表：                        │
│  ┌───────────────────────────────┐ │
│  │ ABC123XYZ | 200能量 | 未使用  │ │
│  │ 创建时间: 2026-02-06 10:00    │ │
│  │ [复制] [删除]                 │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ DEF456UVW | 500能量 | 已使用  │ │
│  │ 使用者: user@example.com      │ │
│  │ 使用时间: 2026-02-06 11:00    │ │
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
```

#### 生成兑换码弹窗
```
┌─────────────────────────────┐
│  生成兑换码                  │
├─────────────────────────────┤
│  能量值: [200] 能量          │
│  备注:   [活动赠送]          │
│                             │
│  [取消]  [生成]              │
└─────────────────────────────┘
```

## 四、兑换码生成规则

### 格式
- 长度：8-12 位
- 字符集：大写字母（A-Z）+ 数字（0-9）
- 排除易混淆字符：0/O, 1/I（可选）
- 示例：`ABC123XYZ`, `K8M9N2P4Q`

### 生成算法
```typescript
function generateRedemptionCode(): string {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789' // 排除0/O/1/I
  let code = ''
  for (let i = 0; i < 9; i++) {
    code += chars[Math.floor(Math.random() * chars.length)]
  }
  return code
}

// 检查唯一性
async function ensureUniqueCode(): Promise<string> {
  let code = generateRedemptionCode()
  let attempts = 0
  while (attempts < 10) {
    const existing = await getRedemptionCode(code)
    if (!existing) return code
    code = generateRedemptionCode()
    attempts++
  }
  throw new Error('无法生成唯一兑换码，请重试')
}
```

## 五、文件结构

```
src/
├── app/
│   ├── admin/
│   │   └── redemption-codes/
│   │       └── page.tsx          # 后台管理页面
│   └── api/
│       └── admin/
│           └── redemption-codes/
│               ├── route.ts      # GET/POST 列表和创建
│               └── [code]/
│                   └── route.ts  # DELETE 删除（可选）
├── components/
│   └── admin/
│       ├── redemption-code-form.tsx    # 生成兑换码表单
│       └── redemption-code-list.tsx    # 兑换码列表组件
└── lib/
    └── db.ts                    # 扩展数据库函数
```

## 六、实施步骤

### Phase 1: 基础功能（最小可用版本）
1. ✅ 扩展数据库函数（`createRedemptionCode`, `listRedemptionCodes`）
2. ✅ 创建 API 接口（`POST /api/admin/redemption-codes`, `GET /api/admin/redemption-codes`）
3. ✅ 实现权限检查（环境变量管理员邮箱）
4. ✅ 创建后台管理页面（生成+列表）

### Phase 2: 增强功能（可选）
1. 添加删除功能
2. 添加备注字段
3. 添加批量生成功能
4. 添加导出功能（CSV/Excel）
5. 添加统计信息（总生成数、总使用数、总赠送能量等）

## 七、安全考虑

1. **权限控制**：所有后台 API 必须验证管理员身份
2. **兑换码唯一性**：确保生成的兑换码不重复
3. **防暴力破解**：兑换码使用后立即标记，防止重复使用
4. **日志记录**：记录管理员操作（创建、删除兑换码）

## 八、测试要点

1. 生成兑换码的唯一性
2. 权限验证（非管理员无法访问）
3. 兑换码列表分页
4. 兑换码使用后状态更新
5. 删除未使用兑换码的功能
