# 待优化项 & 待开发项

**记录日期**：2026-02-06  
**说明**：本文件为待优化与待开发事项的清单，完成一项可勾选一项。详细说明见 [PROGRESS.md](./PROGRESS.md)。

---

## 待优化项

- [x] **1. 邮箱格式校验**  
  填写邮箱时判断格式（当前无），错误时给出提示。（已完成：登录弹窗校验 + 输入框下与发送/登录时提示）

- [x] **2. 主报告加载状态**  
  从二级页面返回主报告时，若正在加载，避免出现旧的「动态分析」状态，统一为「加载报告中」。（已完成：仅当 URL 带 jobId 时展示分析步骤，否则统一显示「加载报告中」）

- [x] **3. 同命盘报告复用（降本与一致性）**  
  新档案发起主报告或四类深度报告生成前，先判断是否存在相同性别、出生年月日时的档案；若有，可将已有主报告与四类深度报告关联到新档案（或从统一报告库查询）。  
  实现方式：直接基于现有表查询复用，或新增独立报告库表，需实现时定夺。（已完成：基于性别+公历日期+时辰序号匹配，在生成报告时自动复用，节省 LLM 调用成本）

- [x] **4. 四类报告「解读中」状态闪烁**  
  某一报告点击解锁进入解读中后，再点击其他报告会触发短时刷新，导致其他「解读中」按钮短暂变为「解锁报告」。需优化状态与刷新逻辑。（已完成：点击时立即标记 generating，fetchStatus 保留 generating 直到确认完成/失败，createDeepReportJob 返回明确状态时立即更新）

- [x] **5. 首页默认展示逻辑**  
  已有档案的用户：主界面默认锁定最新档案并展示其主报告（不展示「开启解码」欢迎页）。无档案的新用户才默认展示欢迎页。避免未锁定档案时进入深度报告等出现一直加载的 bug。（已完成：首页检查用户档案，如有则自动跳转到主报告页）

- [x] **6. 无档案时深度解读入口**  
  无档案用户从侧边栏点击「深度解读」时，toast 提示：「请先创建档案进行解码开启」，避免进入无档案的深度报告页导致异常。（已完成：侧边栏点击深度解读时检查档案列表，无档案则显示 toast 提示）

- [x] **7. 顶部菜单栏可见性（待定）**  
  部分机型（如带灵动岛的苹果手机）在浏览器贴顶或略微放大时，用户难以找到顶部菜单入口；优化方案待讨论。（已完成：添加 safe-area-inset-top 支持，确保菜单栏在带灵动岛的设备上可见）

- [ ] **8. 加载性能与请求次数**  
  在已有缓存前提下，仍存在加载偏多、体感偏慢的问题，待进一步优化请求策略与缓存失效时机。

- [x] **9. 任务中心改为活动中心**  
  前端将「任务中心」改为「活动中心」；暂时隐藏「邀请任务增加能量」模块，仅保留 Discord 兑换码入口。（已完成：重命名页面标题和侧边栏菜单项，隐藏邀请任务模块，清理相关代码）

- [ ] **10. 邮件验证码人机验证（线上防刷）**  
  **需求延伸**：线上环境用户发起邮件验证码时，先做人机验证（如 CAPTCHA / reCAPTCHA / Turnstile 等），通过后再调用发信接口，防止被恶意刷爆邮件服务与配额。

- [x] **11. 能量扣除防重复扣费（负能量问题）**  
  能量扣除无锁死余额，出现负能量情况。估计源于点击解锁报告时，通过快速刷新，按钮从解读中变成解锁报告，多次点击导致多次扣费的情况。  
  **已完成**：
  - 添加了能量扣除确认弹窗流程，用户需要确认后才能扣除能量，减少误操作。
  - 在前端按钮状态管理上增加了防抖机制（500ms），避免快速连续点击导致重复请求。
  - 修复了兑换码兑换时能量重复增加的问题（`addEarnRecord` 不再自动增加余额）。
  **备注**：后端报告生成任务创建时的加锁或幂等性检查可后续优化。

---

## 待开发项

### 本版本考虑

- [x] **兑换码及对应能量设置的后台功能**  
  支持生成兑换码并配置可兑换能量等。  
  **规划文档**：[兑换码后台管理系统规划.md](./兑换码后台管理系统规划.md)  
  **已完成功能**：
  - ✅ 生成兑换码（设置能量值、备注）
  - ✅ 查看兑换码列表（状态、使用情况、使用者邮箱）
  - ✅ 管理员权限控制（环境变量配置）
  - ✅ 兑换码格式：9位大写字母+数字（排除易混淆字符）
  - ✅ 删除未使用的兑换码
  - ✅ 复制兑换码功能
  - ✅ 统计信息展示
  - ✅ 邮箱验证码登录（与主产品一致）
  - ✅ 数据库迁移脚本（添加 createdAt、note 字段）

- [ ] **付费接入 Stripe**  
  集成 Stripe 支付系统，支持用户通过 Stripe 进行能量充值。需要实现：Stripe 账户配置、支付流程、Webhook 处理、订单管理、支付状态同步等。

- [x] **简繁语言切换能力**  
  支持用户在前端界面切换简体/繁体中文，包括：
  - 前端界面文字（按钮、标签、提示等）的简繁切换
  - 报告中生成的文字内容的简繁切换（主报告、未来运势、仕途探索、财富之路、爱情姻缘等）
  - 用户语言偏好存储（本地存储或用户设置）
  - Prompt 模板中根据用户选择的语言动态调整输出要求
  - LLM 生成报告时根据用户语言偏好输出对应语言的内容
  **已完成功能**：
  - ✅ 使用 `opencc-js` 实现简繁转换
  - ✅ 创建语言上下文（LanguageContext），默认繁体中文
  - ✅ 语言切换组件（已添加到侧边栏）
  - ✅ 所有 prompt 模板添加语言要求变量
  - ✅ 报告生成 API 支持语言参数
  - ✅ 前端 API 调用传递语言参数
  - ✅ 语言偏好保存在 localStorage，刷新后保持
  **说明文档**：[简繁语言切换功能说明.md](./简繁语言切换功能说明.md)

### 下版本考虑

- [ ] **真人 1V1**  
  预约号、订单流程、服务能力及后台能力。

- [ ] **AI 解惑**  
  与报告内容相关的 AI 问答能力。
