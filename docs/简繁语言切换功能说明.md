# 简繁语言切换功能说明

## 功能概述

已实现简繁中文语言切换功能，默认语言为**繁体中文**。用户可以在侧边栏切换语言，所有界面文字和报告内容都会根据用户选择的语言进行显示。

## 安装依赖

首先需要安装 `opencc-js` 库：

```bash
npm install opencc-js
```

## 功能特性

1. **语言上下文管理**：通过 `LanguageProvider` 全局管理语言状态
2. **本地存储**：语言偏好保存在 `localStorage`，刷新后保持
3. **默认繁体**：首次访问默认为繁体中文
4. **报告生成**：所有报告（主报告、深度报告）会根据用户选择的语言生成对应语言的内容
5. **界面翻译**：前端界面文字会根据语言自动转换

## 使用方式

### 用户端

1. 打开侧边栏（点击左上角菜单图标）
2. 在菜单底部找到语言切换器
3. 选择「简体中文」或「繁體中文」
4. 语言偏好会自动保存，下次访问时保持

### 开发者端

#### 在组件中使用翻译

```typescript
import { useLanguage } from '@/lib/context-language'

function MyComponent() {
  const { t, language } = useLanguage()
  
  return (
    <div>
      <p>{t('这是简体文字')}</p>
      {/* 如果当前是繁体，会自动转换为繁体 */}
    </div>
  )
}
```

#### 在 API 调用中传递语言

```typescript
import { useLanguage } from '@/lib/context-language'

function MyComponent() {
  const { language } = useLanguage()
  
  // 创建报告时传递语言参数
  await createReportJob({ archiveId: 'xxx', language })
  await createDeepReportJob(archiveId, reportType, false, language)
}
```

## 技术实现

### 核心文件

- `src/lib/i18n.ts` - 语言转换工具函数
- `src/lib/context-language.tsx` - 语言上下文 Provider
- `src/components/language-switcher.tsx` - 语言切换组件
- `src/lib/services/prompt-builder.ts` - Prompt 构建器（支持语言参数）
- `src/lib/services/report-service.ts` - 报告生成服务（支持语言参数）
- `src/lib/services/deep-report-service.ts` - 深度报告生成服务（支持语言参数）

### Prompt 模板更新

所有 prompt 模板（`main-report`, `future-fortune`, `career-path`, `wealth-road`, `love-marriage`）都已更新，添加了 `{{LANGUAGE_REQUIREMENT}}` 变量，LLM 会根据此变量输出对应语言的内容。

### API 路由更新

- `/api/report/generate` - 主报告生成，支持 `language` 参数
- `/api/report/deep/generate` - 深度报告生成，支持 `language` 参数

## 注意事项

1. **首次安装**：需要运行 `npm install opencc-js` 安装依赖
2. **默认语言**：系统默认使用繁体中文，如需修改默认语言，可修改 `src/lib/i18n.ts` 中的 `getDefaultLanguage` 函数
3. **报告语言**：已生成的报告不会因为切换语言而改变，只有新生成的报告才会使用当前选择的语言
4. **界面翻译**：目前界面文字需要手动使用 `t()` 函数进行翻译，未来可以逐步完善所有组件的翻译

## 待优化项

- [ ] 完善所有组件的界面文字翻译
- [ ] 考虑将语言偏好同步到用户数据库（而非仅 localStorage）
- [ ] 添加更多语言的翻译支持（如英文）
