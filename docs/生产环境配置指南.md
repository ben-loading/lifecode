# 生产环境配置指南

本文档提供从灰度环境迁移到正式生产环境的详细配置步骤。

---

## 前置准备

- ✅ 域名已在 GoDaddy 配置并指向 Vercel
- ✅ 已创建 GitHub `staging` 分支
- ✅ 已设置 GitHub 分支保护规则

---

## 第一部分：Supabase 正式环境配置

### 步骤 1：创建 Supabase 生产项目

1. **登录 Supabase Dashboard**
   - 访问：https://supabase.com/dashboard
   - 使用你的账号登录

2. **创建新项目**
   - 点击 **New Project** 或 **Create a new project**
   - **项目名称**：`lifecode-production`（或你喜欢的名称）
   - **数据库密码**：设置强密码（**重要：记录此密码**）
   - **区域选择**：建议选择与 Vercel 部署区域一致（如 `Southeast Asia (Singapore)`）
   - 点击 **Create new project**
   - 等待项目创建完成（约 2-3 分钟）

3. **记录项目信息**
   - 项目创建完成后，进入 **Settings** → **API**
   - 记录以下信息（稍后需要在 Vercel 中配置）：
     - **Project URL**：`https://xxx.supabase.co`
     - **anon public key**：`eyJhbG...`（以 `eyJ` 开头）
     - **service_role key**：`eyJhbG...`（以 `eyJ` 开头，**保密**）
   - 进入 **Settings** → **Database**
   - 记录 **Connection string**（URI 格式）：`postgresql://postgres:[PASSWORD]@db.xxx.supabase.co:5432/postgres`

### 步骤 2：执行数据库初始化脚本

1. **打开 SQL Editor**
   - 在 Supabase Dashboard 左侧菜单选择 **SQL Editor**
   - 点击 **New query**

2. **执行主初始化脚本**
   - 打开项目中的 `supabase/init.sql` 文件
   - 复制全部内容
   - 粘贴到 SQL Editor
   - 点击 **Run** 或按 `Ctrl+Enter`（Mac: `Cmd+Enter`）
   - 等待执行完成，确认没有错误
   - **重要**：如果遇到 `normalized_birth_date` 相关错误，说明脚本已更新，请确保使用最新版本的 `init.sql`

3. **执行用户创建触发器脚本（可选）**
   - 根据项目需求选择：
     - **推荐**：不执行 `002_supabase_auth_user.sql`（用户由应用在登录时创建）
     - **或**：执行 `002_supabase_auth_user.sql`（Auth 注册时自动创建 User 记录）
   - 如果执行后出现错误，执行 `003_fix_new_user_trigger.sql` 修复

4. **验证表结构**
   - 在 SQL Editor 中执行：
     ```sql
     SELECT table_name FROM information_schema.tables 
     WHERE table_schema = 'public' 
     ORDER BY table_name;
     ```
   - 应看到以下表：
     - Archive
     - DeepReport
     - Invite
     - MainReport
     - RedemptionCode
     - ReportJob
     - Transaction
     - User

5. **验证 Archive 表字段（重要）**
   - 在 SQL Editor 中执行：
     ```sql
     SELECT column_name, data_type 
     FROM information_schema.columns 
     WHERE table_schema = 'public' 
       AND table_name = 'Archive'
     ORDER BY ordinal_position;
     ```
   - 确认包含以下字段：
     - `normalized_birth_date` (DATE 类型)
     - `normalized_time_index` (INTEGER 类型)
   - **如果缺少这些字段**，执行以下 SQL 添加：
     ```sql
     ALTER TABLE public."Archive" 
       ADD COLUMN IF NOT EXISTS normalized_birth_date DATE,
       ADD COLUMN IF NOT EXISTS normalized_time_index INTEGER;
     
     CREATE INDEX IF NOT EXISTS idx_archive_normalized_birth 
       ON public."Archive"(gender, normalized_birth_date, normalized_time_index);
     ```

### 步骤 3：配置 Supabase Auth

1. **启用 Email 提供商**
   - 进入 **Authentication** → **Providers** → **Email**
   - 确保 **Enable Email provider** 已开启

2. **配置邮件模板（可选）**
   - 进入 **Authentication** → **Email Templates**
   - 可以自定义验证码邮件模板
   - 使用 `{{ .Token }}` 显示 6 位验证码

3. **配置自定义 SMTP（重要）**
   - 进入 **Authentication** → **SMTP Settings**（或 **Project Settings** → **Auth** → **SMTP**）
   - 根据你的邮件服务商配置：
   
   **如果使用 Brevo**：
   - **Sender email**：`no-reply@yourdomain.com`（你的正式域名邮箱）
   - **Sender name**：`人生解碼`
   - **Host**：`smtp-relay.brevo.com`
   - **Port**：`587`
   - **Username**：你的 Brevo SMTP 登录邮箱
   - **Password**：Brevo SMTP 密钥（不是账号密码）
   
   **如果使用 Resend**：
   - **Sender email**：`no-reply@yourdomain.com`
   - **Sender name**：`人生解碼`
   - **Host**：`smtp.resend.com`
   - **Port**：`587`
   - **Username**：`resend`（固定）
   - **Password**：Resend API Key

4. **设置认证速率限制**
   - 进入 **Authentication** → **Rate Limits**
   - 根据需要调整每小时发送上限（建议 30-60 条/小时）

5. **测试邮件发送**
   - 在 **Authentication** → **Users** 中创建测试用户
   - 发送验证码，确认邮件能正常接收

### 步骤 4：记录 Supabase 环境变量

记录以下值，稍后在 Vercel 中配置：

- `NEXT_PUBLIC_SUPABASE_URL` = `https://xxx.supabase.co`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` = `eyJhbG...`（anon key）
- `SUPABASE_SERVICE_ROLE_KEY` = `eyJhbG...`（service_role key，保密）
- `DATABASE_URL` = `postgresql://postgres:[PASSWORD]@db.xxx.supabase.co:5432/postgres?sslmode=require`

---

## 第二部分：Vercel 生产环境配置

### 步骤 1：确认项目配置

1. **登录 Vercel Dashboard**
   - 访问：https://vercel.com
   - 使用你的账号登录

2. **找到现有项目**
   - 在项目列表中找到 `lifecode` 项目
   - 点击进入项目

3. **确认 Git 配置**
   - 进入 **Settings** → **Git**
   - 确认 **Production Branch** 设置为 `main`
   - 确认 **Automatic Preview Deployments** 已启用

### 步骤 2：配置环境变量（按环境区分）

1. **进入环境变量设置**
   - 进入 **Settings** → **Environment Variables**

2. **配置 Supabase 变量（Production 环境）**

   点击 **Add New**，依次添加：

   | 变量名 | 值 | 环境选择 |
   |--------|-----|---------|
   | `NEXT_PUBLIC_SUPABASE_URL` | 从 Supabase 复制的 Project URL | ✅ Production |
   | `NEXT_PUBLIC_SUPABASE_ANON_KEY` | 从 Supabase 复制的 anon key | ✅ Production |
   | `SUPABASE_SERVICE_ROLE_KEY` | 从 Supabase 复制的 service_role key | ✅ Production |
   | `DATABASE_URL` | 从 Supabase 复制的 Connection string | ✅ Production |

   **重要**：只勾选 **Production**，不要勾选 Preview 或 Development

3. **配置 LLM 变量（Production 环境）**

   | 变量名 | 值 | 环境选择 |
   |--------|-----|---------|
   | `DEEPSEEK_API_KEY` | 你的 DeepSeek API Key | ✅ Production |
   | `LLM_PROVIDER` | `deepseek` | ✅ Production |

4. **配置 Stripe 变量（Production 环境）**

   **重要**：使用 Stripe **Live mode** 的密钥（不是测试密钥）

   - 登录 [Stripe Dashboard](https://dashboard.stripe.com)
   - 切换右上角到 **Live mode**
   - 进入 **Developers** → **API keys**
   - 复制 **Secret key**（以 `sk_live_` 开头）
   - 复制 **Publishable key**（以 `pk_live_` 开头）

   | 变量名 | 值 | 环境选择 |
   |--------|-----|---------|
   | `STRIPE_SECRET_KEY` | `sk_live_...`（Live mode 密钥） | ✅ Production |
   | `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` | `pk_live_...`（Live mode 公钥） | ✅ Production |

5. **配置 Stripe Webhook（Production 环境）**

   **详细步骤**：
   
   1. **登录 Stripe Dashboard**
      - 访问：https://dashboard.stripe.com
      - 使用你的账号登录
      - **重要**：确保右上角切换到 **Live mode**（不是 Test mode）
   
   2. **进入 Webhooks 设置**
      - 点击左侧菜单 **Developers**（开发者）
      - 在子菜单中选择 **Webhooks**
      - 你会看到现有的 Webhook endpoints 列表（如果有）
   
   3. **添加新的 Webhook Endpoint**
      - 点击右上角的 **Add endpoint** 或 **+ Add endpoint** 按钮
      - 会弹出配置对话框
   
   4. **配置 Endpoint 信息**
      - **Endpoint URL**：
        - 输入你的生产环境 Webhook URL
        - 格式：`https://your-production-domain.com/api/payment/webhook`
        - 例如：`https://lifecode.com/api/payment/webhook`
        - **注意**：确保域名已正确配置并指向 Vercel
      
      - **Description**（可选）：
        - 输入描述，如：`Production - Payment Webhook`
        - 方便后续识别和管理
   
   5. **选择要监听的事件**
      - 在 **Events to send** 或 **Select events to listen to** 区域
      - 点击 **Select events** 或 **+ Select events**
      - 在事件列表中，找到并勾选：
        - ✅ **`checkout.session.completed`**（支付会话完成）
      - 点击 **Add events** 或确认
   
   6. **保存 Endpoint**
      - 点击 **Add endpoint** 或 **Save** 按钮
      - Stripe 会创建 endpoint 并显示详情页面
   
   7. **获取 Webhook Signing Secret**
      - 在 endpoint 详情页面，找到 **Signing secret** 部分
      - 点击 **Reveal** 或 **Click to reveal** 按钮
      - 复制显示的密钥（以 `whsec_` 开头）
      - **重要**：这个密钥只显示一次，请立即保存
      - 格式示例：`whsec_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`
   
   8. **测试 Webhook（可选）**
      - 在 endpoint 详情页面，可以点击 **Send test webhook** 测试
      - 或使用 Stripe CLI 测试：`stripe listen --forward-to https://your-domain.com/api/payment/webhook`
   
   **配置测试环境的 Webhook（Preview 环境）**：
   
   如果需要为 staging 分支配置测试 Webhook：
   
   1. 在 Stripe Dashboard 右上角切换到 **Test mode**
   2. 重复上述步骤，但使用测试环境的 URL：
      - Endpoint URL：`https://staging.lifecode.com/api/payment/webhook`（或预览 URL）
   3. 记录测试环境的 Webhook signing secret
   4. 在 Vercel 中为 Preview 环境配置这个 secret

   | 变量名 | 值 | 环境选择 |
   |--------|-----|---------|
   | `STRIPE_WEBHOOK_SECRET` | `whsec_...`（Webhook 签名密钥） | ✅ Production |

6. **配置管理员邮箱（Production 环境）**

   | 变量名 | 值 | 环境选择 |
   |--------|-----|---------|
   | `ADMIN_EMAILS` | `admin@yourdomain.com,admin2@yourdomain.com`（逗号分隔） | ✅ Production |

7. **配置可选变量**

   | 变量名 | 值 | 环境选择 |
   |--------|-----|---------|
   | `NODE_ENV` | `production` | ✅ Production |

### 步骤 3：配置 Preview 环境变量（用于 staging 分支）

**重要**：为 staging 分支配置测试环境变量

1. **Supabase 变量（Preview 环境）**
   - 使用现有的灰度环境 Supabase 项目信息
   - 为以下变量添加 **Preview** 环境的值：
     - `NEXT_PUBLIC_SUPABASE_URL`（灰度环境 URL）
     - `NEXT_PUBLIC_SUPABASE_ANON_KEY`（灰度环境 anon key）
     - `SUPABASE_SERVICE_ROLE_KEY`（灰度环境 service_role key）
     - `DATABASE_URL`（灰度环境数据库连接）

2. **Stripe 变量（Preview 环境）**
   - 使用 Stripe **Test mode** 的密钥
   - 为以下变量添加 **Preview** 环境的值：
     - `STRIPE_SECRET_KEY`（`sk_test_...`）
     - `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`（`pk_test_...`）
     - `STRIPE_WEBHOOK_SECRET`（测试环境 webhook secret）

3. **其他变量（Preview 环境）**
   - `DEEPSEEK_API_KEY`（可以与 Production 相同）
   - `LLM_PROVIDER`：`deepseek`
   - `ADMIN_EMAILS`（测试管理员邮箱）

### 步骤 4：配置域名

1. **添加生产域名**
   - 进入 **Settings** → **Domains**
   - 点击 **Add Domain**
   - 输入你的主域名（如 `lifecode.com`）
   - 点击 **Add**
   - Vercel 会自动验证 DNS 配置

2. **添加 www 子域名（可选）**
   - 添加 `www.lifecode.com`
   - Vercel 会自动配置重定向

3. **配置预览域名（可选）**
   - 如果需要为 staging 配置独立域名：
     - 添加 `staging.lifecode.com`
     - 在域名设置中选择 **Assign to Preview Deployments**

4. **等待 SSL 证书配置**
   - DNS 生效后，Vercel 会自动申请 SSL 证书
   - 通常需要几分钟到几小时
   - 在 Domains 页面查看状态

### 步骤 5：重新部署

1. **触发重新部署**
   - 进入 **Deployments** 页面
   - 找到最新的部署
   - 点击 **⋯** → **Redeploy**
   - 或推送到 `main` 分支触发自动部署

2. **验证环境变量生效**
   - 部署完成后，访问：`https://your-domain.com/api/debug/env`
   - 检查返回的 JSON，确认所有变量都已设置

---

## 第三部分：验证配置

### 验证清单

**Supabase 验证**：
- [ ] 数据库表结构已创建
- [ ] Auth 邮件发送正常
- [ ] SMTP 配置正确

**Vercel 验证**：
- [ ] 所有环境变量已配置（Production）
- [ ] Preview 环境变量已配置（用于 staging）
- [ ] 域名已添加并生效
- [ ] SSL 证书已配置

**功能验证**：
- [ ] 用户注册/登录功能正常
- [ ] 邮件验证码能正常接收
- [ ] 主报告生成功能正常
- [ ] Stripe 支付功能正常（使用测试卡）
- [ ] Webhook 能正常接收和处理

---

## 第四部分：后续维护

### 日常开发流程

1. **开发新功能**
   ```bash
   git checkout staging
   git pull origin staging
   # ... 开发代码 ...
   git push origin staging  # 自动部署到预览环境
   ```

2. **测试通过后发布**
   - 在 GitHub 创建 Pull Request: `staging` → `main`
   - 审查通过后合并
   - `main` 分支自动部署到生产环境

### 环境变量更新

- **更新 Production 变量**：在 Vercel → Settings → Environment Variables 中修改，保存后需要重新部署
- **更新 Preview 变量**：同样在 Environment Variables 中修改 Preview 环境的值

---

## 故障排查

### 常见问题

1. **环境变量未生效**
   - 确认变量已勾选正确的环境（Production/Preview）
   - 保存后必须重新部署
   - 检查 `/api/debug/env` 端点

2. **域名无法访问**
   - 检查 DNS 记录是否正确
   - 等待 DNS 传播（最多 24 小时）
   - 检查 Vercel Domains 页面状态

3. **SSL 证书未配置**
   - 确认 DNS 已正确配置
   - 等待更长时间（最多 24 小时）
   - 联系 Vercel 支持

4. **Stripe Webhook 未接收**
   - 确认 Webhook URL 正确
   - 确认 Webhook secret 正确
   - 检查 Stripe Dashboard → Webhooks → 日志

5. **创建档案失败：找不到 `normalized_birth_date` 列**
   - **原因**：数据库表缺少必要的字段
   - **解决方案**：
     1. 登录 Supabase Dashboard → SQL Editor
     2. 执行以下 SQL 添加缺失字段：
        ```sql
        ALTER TABLE public."Archive" 
          ADD COLUMN IF NOT EXISTS normalized_birth_date DATE,
          ADD COLUMN IF NOT EXISTS normalized_time_index INTEGER;
        
        CREATE INDEX IF NOT EXISTS idx_archive_normalized_birth 
          ON public."Archive"(gender, normalized_birth_date, normalized_time_index);
        ```
     3. 验证字段已添加：
        ```sql
        SELECT column_name, data_type 
        FROM information_schema.columns 
        WHERE table_schema = 'public' 
          AND table_name = 'Archive'
          AND column_name IN ('normalized_birth_date', 'normalized_time_index');
        ```
     4. 应该返回 2 行记录

6. **后台兑换码查询/生成失败：500 错误（找不到 `note` 列）**
   - **原因**：`RedemptionCode` 表缺少 `note` 字段
   - **解决方案**：
     1. 登录 Supabase Dashboard → SQL Editor
     2. 执行以下 SQL 添加缺失字段：
        ```sql
        ALTER TABLE public."RedemptionCode" 
          ADD COLUMN IF NOT EXISTS note TEXT;
        ```
     3. 验证字段已添加：
        ```sql
        SELECT column_name, data_type 
        FROM information_schema.columns 
        WHERE table_schema = 'public' 
          AND table_name = 'RedemptionCode'
          AND column_name = 'note';
        ```
     4. 应该返回 1 行记录

7. **后台登录失败：500 错误（找不到 `Session` 或 `VerificationCode` 表）**
   - **原因**：认证相关的表不存在
   - **解决方案**：
     1. 登录 Supabase Dashboard → SQL Editor
     2. 执行以下 SQL 创建缺失的表：
        ```sql
        -- 创建 Session 表
        CREATE TABLE IF NOT EXISTS public."Session" (
          id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
          token TEXT UNIQUE NOT NULL,
          "userId" TEXT NOT NULL,
          "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
          "expiresAt" TIMESTAMP(3) NOT NULL,
          CONSTRAINT "Session_userId_fkey" FOREIGN KEY ("userId") 
            REFERENCES public."User"(id) ON DELETE CASCADE ON UPDATE CASCADE
        );
        
        CREATE INDEX IF NOT EXISTS "Session_token_idx" ON public."Session"(token);
        CREATE INDEX IF NOT EXISTS "Session_userId_idx" ON public."Session"("userId");
        
        -- 创建 VerificationCode 表
        CREATE TABLE IF NOT EXISTS public."VerificationCode" (
          email TEXT PRIMARY KEY,
          code TEXT NOT NULL,
          "expiresAt" BIGINT NOT NULL
        );
        ```
     3. 验证表已创建：
        ```sql
        SELECT table_name 
        FROM information_schema.tables 
        WHERE table_schema = 'public' 
          AND table_name IN ('Session', 'VerificationCode');
        ```
     4. 应该返回 2 行记录

8. **创建深度报告任务失败：找不到 `DeepReportJob` 表**
   - **原因**：`DeepReportJob` 表不存在
   - **解决方案**：
     1. 登录 Supabase Dashboard → SQL Editor
     2. 执行以下 SQL 创建缺失的表：
        ```sql
        CREATE TABLE IF NOT EXISTS public."DeepReportJob" (
          id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
          "archiveId" TEXT NOT NULL,
          "reportType" TEXT NOT NULL,
          status TEXT NOT NULL DEFAULT 'pending',
          "currentStep" INTEGER,
          "totalSteps" INTEGER,
          "stepLabel" TEXT,
          error TEXT,
          "completedAt" TIMESTAMP(3),
          "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
          "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
          CONSTRAINT "DeepReportJob_archiveId_fkey" FOREIGN KEY ("archiveId")
            REFERENCES public."Archive"(id) ON DELETE CASCADE ON UPDATE CASCADE
        );
        
        CREATE INDEX IF NOT EXISTS "DeepReportJob_archiveId_idx" ON public."DeepReportJob"("archiveId");
        CREATE INDEX IF NOT EXISTS "DeepReportJob_reportType_idx" ON public."DeepReportJob"("reportType");
        CREATE INDEX IF NOT EXISTS "DeepReportJob_status_idx" ON public."DeepReportJob"(status);
        CREATE INDEX IF NOT EXISTS "DeepReportJob_createdAt_idx" ON public."DeepReportJob"("createdAt");
        ```
     3. 验证表已创建：
        ```sql
        SELECT table_name 
        FROM information_schema.tables 
        WHERE table_schema = 'public' 
          AND table_name = 'DeepReportJob';
        ```
     4. 应该返回 1 行记录

---

## 安全注意事项

1. **密钥安全**
   - 所有密钥只存储在 Vercel 环境变量中
   - 不要提交密钥到代码仓库
   - 定期轮换密钥

2. **数据库安全**
   - `SUPABASE_SERVICE_ROLE_KEY` 具有管理员权限，不要暴露给前端
   - 定期备份数据库

3. **访问控制**
   - 使用 `ADMIN_EMAILS` 限制后台访问
   - 定期审查管理员列表

---

## 联系支持

- **Vercel 支持**：https://vercel.com/support
- **Supabase 支持**：https://supabase.com/support
- **Stripe 支持**：https://support.stripe.com
